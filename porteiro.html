<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>EXCLUSIVE PASS – Porteiro</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
  body{margin:0;padding:0;background:#0f0c29;color:#fff;font-family:Segoe UI,sans-serif;height:100vh;display:flex;flex-direction:column;overflow:hidden}
  .top {background:#16213e;padding:15px;text-align:center;position:relative;flex-shrink:0;display:flex;flex-direction:column;align-items:center;gap:10px;}
  h1{margin:0;font-size:32px;color:#ffffff}
  .contador{font-size:48px;color:#00d4aa;font-weight:bold}
  .impBtn{background:#00d4aa;padding:10px 20px;font-size:16px;border:none;border-radius:8px}
  .toggleCam{
    background: #9b59b6;
    color: #000;
    padding: 10px 20px;
    border-radius: 8px;
    font-size: 16px;
    border: none;
    cursor: pointer;
    align-items:center;
    margin-left: 0px; /* distância entre os botões */
}
  #video{width:100%;background:#000;object-fit:cover;transition:flex 0.4s}
  .videoContainer{flex:1;overflow:hidden;position:relative;transition:flex 0.4s}
  .lista{padding:15px;background:#16213e;overflow-y:auto;transition:max-height 0.4s}
  .lista div{background:#1e1e2e;padding:12px 16px;margin:6px 0;border-radius:12px;font-size:18px}
  #resultado{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:rgba(0,0,0,0.95);padding:40px 50px;border-radius:25px;text-align:center;z-index:99;display:none;box-shadow:0 0 60px #000;width:90%;max-width:400px}
  .ok{color:#2ecc71;font-size:50px;font-weight:bold}
  .erro{color:#e74c3c;font-size:50px;font-weight:bold}
  #nome{font-size:46px;color:#ffd700;margin:15px 0}
  #cat{background:#1a1a2e;padding:15px 50px;border-radius:50px;display:inline-block;font-size:36px}
  button{margin-top:25px;padding:15px 50px;font-size:28px;background:#00d4aa;border:none;border-radius:15px;color:#000;cursor:pointer}
</style>
</head>
<body>

<div class="top">
  <h1>EXCLUSIVE PASS - PORTARIA</h1>
  <div class="contador"><span id="contador">0</span> / <span id="total">0</span></div>
  <div class="btnRow">
    <button class="impBtn" onclick="importarClique()">IMPORTAR LISTA</button>
    <button class="toggleCam" id="toggleBtn" onclick="toggleCamera()">Ocultar Câmera</button>
</div>
<input type="file" id="imp" style="display:none" accept=".json" onchange="importar(event)">

</div>

<div class="videoContainer" id="videoContainer">
  <video id="video" autoplay playsinline muted></video>
</div>

<div class="lista" id="lista">
  <div style="text-align:center;color:#666">Importe a lista para começar</div>
</div>

<div id="resultado">
  <div id="msg"></div>
  <div id="nome"></div>
  <div id="cat"></div>
  <button onclick="fechar()">OK</button>
</div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
<script>
let lista = [];
let escaneando = false;
let cameraVisivel = true;
const video = document.getElementById("video");
const videoContainer = document.getElementById("videoContainer");
const listaDiv = document.getElementById("lista");
const toggleBtn = document.getElementById("toggleBtn");

function toggleCamera(){
  cameraVisivel = !cameraVisivel;
  if(cameraVisivel){
    videoContainer.style.flex = "1";
    listaDiv.style.maxHeight = "280px";
    toggleBtn.innerHTML = "Ocultar Câmera";
    escaneando = true;
    tick();
  } else {
    videoContainer.style.flex = "0";
    videoContainer.style.height = "0";
    listaDiv.style.maxHeight = "none";
    listaDiv.style.flex = "1";
    toggleBtn.innerHTML = "Mostrar Câmera";
    escaneando = false;
  }
}

// IMPORTAR LISTA
function importarClique(){
  escaneando = false;
  document.getElementById("imp").click();
}
function importar(e){
  const file = e.target.files[0];
  if(!file) return;
  
  const reader = new FileReader();
  reader.onload = function(ev){
    const textoCripto = ev.target.result.trim();
    
    // FRASE SECRETA QUE SÓ VOCÊ SABE (mude pra sua frase real)
    const FRASE_SECRETA = "QSBmZXN0YSBkbyBDYWxpbCBkaWEgMTIvMTIgw6kgc8OzIHByYSBxdWVtIMOpIFZJUCBkZSB2ZXJkYWRlIDI1MTI";
    
    // Gera uma chave forte a partir da frase (impossível de reverter)
    const chave = CryptoJS.SHA256(FRASE_SECRETA + "ExclusivePass2025").toString();
    const salt = CryptoJS.SHA256("PASSEVIP" + FRASE_SECRETA).toString().substr(0,16);

    try{
      const bytes = CryptoJS.AES.decrypt(textoCripto, chave, {
        iv: CryptoJS.enc.Utf8.parse(salt),
        mode: CryptoJS.mode.CBC,
        padding: CryptoJS.pad.Pkcs7
      });

      const jsonPuro = bytes.toString(CryptoJS.enc.Utf8);
      if(!jsonPuro || !jsonPuro.startsWith('[')) throw "inválido";

      lista = JSON.parse(jsonPuro);
      salvar();
      atualiza();
      if(document.getElementById("total")) document.getElementById("total").textContent = lista.length;
      if(document.getElementById("contador")) document.getElementById("contador").textContent = lista.filter(p=>p.usado).length;
      if(typeof atualizarLista === "function") atualizarLista();

    }catch(err){
      alert("Lista inválida ou corrompida!\nUse apenas arquivos gerados pelo sistema oficial.");
    }
  };
  reader.readAsText(file);
}

// CÂMERA
navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"}, audio:false})
  .then(stream => {
    video.srcObject = stream;
    video.play();
    escaneando = true;
    tick();
  })
  .catch(() => alert("Permita a câmera"));

const canvas = document.createElement("canvas");
const ctx = canvas.getContext("2d", {willReadFrequently:true});

function tick(){
  if(!escaneando || !cameraVisivel || video.readyState !== video.HAVE_ENOUGH_DATA){
    requestAnimationFrame(tick);
    return;
  }
  canvas.width = video.videoWidth;
  canvas.height = video.videoHeight;
  ctx.drawImage(video,0,0,canvas.width,canvas.height);
  const code = jsQR(ctx.getImageData(0,0,canvas.width,canvas.height).data, canvas.width, canvas.height, {inversionAttempts:"dontInvert"});
  if(code){
    validar(code.data);
    setTimeout(()=>{ if(cameraVisivel) escaneando = true; tick(); }, 3000);
    escaneando = false;
  }
  requestAnimationFrame(tick);
}

// VALIDAÇÃO E LISTA
function validar(id){
  const p = lista.find(x=>x.id===id);
  if(!p){ tocarErro(); mostrar("INVÁLIDO","erro"); return; }
  if(p.usado){ tocarErro(); mostrar("JÁ ENTROU","erro"); return; }
  p.usado = true;
  document.getElementById("contador").textContent = lista.filter(x=>x.usado).length;
  tocarOk();
  mostrar("LIBERADO!","ok",p);
  atualizarLista();
}

function atualizarLista(){
  const entrou = lista.filter(p=>p.usado).reverse();
  const l = document.getElementById("lista");
  l.innerHTML = "";
  if(entrou.length===0){
    l.innerHTML = '<div style="text-align:center;color:#666">Ninguém entrou ainda</div>';
    return;
  }
  entrou.forEach(p => {
    const div = document.createElement("div");
    div.textContent = `${p.nome} — ${p.categoria}`;
    l.appendChild(div);
  });
}

function mostrar(txt, tipo, pessoa=null){
  document.getElementById("msg").textContent = txt;
  document.getElementById("msg").className = tipo;
  document.getElementById("nome").textContent = pessoa ? pessoa.nome.toUpperCase() : "";
  document.getElementById("cat").textContent = pessoa ? pessoa.categoria : "";
  document.getElementById("resultado").style.display = "block";
}
function fechar(){ document.getElementById("resultado").style.display="none"; }

// SONS
function tocarOk(){
  const ctx = new AudioContext();
  const o = ctx.createOscillator();
  o.type="sine"; o.frequency.value=900;
  o.connect(ctx.destination); o.start(); o.stop(ctx.currentTime+0.15);
}
function tocarErro(){
  const ctx = new AudioContext();
  const o = ctx.createOscillator();
  o.type="sawtooth"; o.frequency.value=180;
  o.connect(ctx.destination); o.start(); o.stop(ctx.currentTime+0.5);
}
</script>
</body>
</html>




