<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <link rel="manifest" href="/manifest.json">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="apple-mobile-web-app-title" content="EXCLUSIVE PASS">
  <link rel="apple-touch-icon" href="/icons/icon-180.png">

  <meta charset="UTF-8">
  <title>EXCLUSIVE PASS - DESIGN FINAL</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&display=swap" rel="stylesheet">

<style>
  body{font-family:'Segoe UI',sans-serif;background:#0f0c29;color:#eee;margin:0;padding:20px}
  .box{max-width:900px;margin:auto;background:#16213e;padding:30px;border-radius:20px;box-shadow:0 0 40px #000}
  button{padding:16px;margin:10px 0;width:100%;border-radius:15px;border:none;font-size:18px;cursor:pointer;font-weight:bold}
  button.gerar{background:#ffd700;color:#000;font-size:20px}
  button.zip{background:#e67e22;color:#fff;font-size:20px}
  button.exp{background:#3498db;color:#fff}
  button.imp{background:#9b59b6;color:#fff}
  button.limpar{background:#c0392b;color:#fff;font-size:18px}
  #lista div{background:#1a1a5e;padding:16px;margin:10px 0;border-radius:12px;font-size:18px}
  h1{text-align:center;color:#ffd700;font-size:46px;margin:10px 0}
</style>
</head>

<body>
<div class="box">
  <h1>EXCLUSIVE PASS</h1>

  <button class="gerar" onclick="gerarIndividuais()">GERAR PNG INDIVIDUAIS</button>
  <button class="zip" onclick="gerarZip()">GERAR TODOS + ZIP (RECOMENDADO)</button>

  <button class="imp" onclick="document.getElementById('file').click()">IMPORTAR LISTA</button>
  <input type="file" id="file" style="display:none" accept=".json" onchange="importar(event)">

  <button class="limpar" onclick="limparTudo()">LIMPAR LISTA</button>

  <h2 style="color:#00d4aa;margin-top:30px">Convidados (<span id="total">0</span>)</h2>
  <div id="lista"></div>
</div>

<script src="https://cdn.jsdelivr.net/npm/davidshimjs-qrcodejs@0.0.2/qrcode.min.js"></script>
<script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.2.0/crypto-js.min.js"></script>

<script>
let lista = JSON.parse(localStorage.getItem("n")||"[]");
atualiza();

/* ------------------------- DOWNLOAD --------------------------*/
function download(blob, nome) {
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url; a.download = nome;
  document.body.appendChild(a);
  a.click();
  setTimeout(() => { URL.revokeObjectURL(url); document.body.removeChild(a); }, 100);
}

/* ------------------------- CRIA CONVITE --------------------------*/
async function criarConvite(p) {
  const svg = `
  <svg xmlns='http://www.w3.org/2000/svg' width='600' height='1066'>
    <g stroke='#d4af37' fill='none'>
      <line x1='-120' y1='100' x2='700' y2='-50' stroke-width='6' opacity='.60'/>
    </g>
  </svg>`;

  const svgBase64 = 'data:image/svg+xml;base64,' + btoa(unescape(encodeURIComponent(svg)));

  const div = document.createElement("div");
  div.style.cssText = `
    width:600px;height:1066px;background:#212B37;
    background-image:url("${svgBase64}");background-size:cover;
    position:absolute;left:-9999px;top:0;display:flex;flex-direction:column;
    padding:80px 50px 60px;border-radius:50px;gap:40px;
    font-family:'Cinzel',serif;
  `;

  const primeiroNome = (p.nome||'').split(" ")[0].toUpperCase();

  div.innerHTML = `
    <div style="background:#1a1a2e;color:white;font-size:34px;padding:22px 90px;border-radius:50px;">
      FESTA EXCLUSIVA
    </div>
    <p style="color:#a0e7ff;font-size:36px;margin:0;">Você está convidado(a)!</p>
    <h1 style="font-size:52px;color:white;margin:0;">${primeiroNome}</h1>

    <div style="background:#1a1a2e;color:white;font-size:56px;padding:35px 140px;border-radius:70px;">
      ${p.categoria}
    </div>

    <div id="qr-${p.id}" style="width:420px;height:420px;background:white;padding:30px;border-radius:45px;"></div>
  `;

  document.body.appendChild(div);

  new QRCode(document.getElementById(`qr-${p.id}`), {
    text: p.id, width:360, height:360, correctLevel: QRCode.CorrectLevel.H
  });

  await new Promise(r => setTimeout(r, 900));
  const canvas = await html2canvas(div, {scale:3});
  document.body.removeChild(div);
  return canvas;
}

/* ------------------------- GERAR PNG --------------------------*/
async function gerarIndividuais() {
  if (!lista.length) return alert("Lista vazia!");

  for (let p of lista) {
    const canvas = await criarConvite(p);
    canvas.toBlob(b => download(b, `${p.nome.split(" ")[0]}_${p.categoria}.png`));
  }

  alert("PNG gerados!");
}

/* ------------------------- GERAR ZIP --------------------------*/
async function gerarZip() {
  if (!lista.length) return alert("Lista vazia!");

  const zip = new JSZip();
  const pasta = zip.folder("EXCLUSIVE_PASS");

  for (let p of lista) {
    const canvas = await criarConvite(p);
    const blob = await new Promise(res => canvas.toBlob(res));
    pasta.file(`${p.nome.split(" ")[0]}_${p.categoria}.png`, blob);
  }

  const zipBlob = await zip.generateAsync({type:"blob"});
  download(zipBlob, `EXCLUSIVE_PASS_${lista.length}.zip`);
}

/* ------------------------- IMPORTAR --------------------------*/
function importar(e){
  const file = e.target.files[0];
  if(!file) return;

  const reader = new FileReader();
  reader.onload = ev => {
    try {
      lista = JSON.parse(ev.target.result);
      salvar(); atualiza();
    } catch {
      alert("Arquivo inválido!");
    }
  };
  reader.readAsText(file);
}

/* ------------------------- OUTROS --------------------------*/
function salvar(){ localStorage.setItem("n", JSON.stringify(lista)); }

function atualiza(){
  const l = document.getElementById("lista");
  l.innerHTML = lista.map(p=>`<div><b>${p.nome}</b> — ${p.categoria}</div>`).join("");
  document.getElementById("total").textContent = lista.length;
}

function limparTudo(){
  if(confirm("APAGAR TUDO?")){
    lista=[]; salvar(); atualiza();
  }
}
</script>
</body>
</html>
