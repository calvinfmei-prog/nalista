<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <link rel="manifest" href="manifest.json">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="apple-mobile-web-app-title" content="EXCLUSIVE PASS">
  <link rel="apple-touch-icon" href="/icons/icon-180.png">

  <meta charset="UTF-8">
  <title>EXCLUSIVE PASS - DESIGN FINAL</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&display=swap" rel="stylesheet">

<style>
  body{font-family:'Segoe UI',sans-serif;background:#0f0c29;color:#eee;margin:0;padding:20px}
  .box{max-width:900px;margin:auto;background:#16213e;padding:30px;border-radius:20px;box-shadow:0 0 40px #000}
  button{padding:16px;margin:10px 0;width:100%;border-radius:15px;border:none;font-size:18px;cursor:pointer;font-weight:bold}
  button.gerar{background:#ffd700;color:#000;font-size:20px}
  button.zip{background:#e67e22;color:#fff;font-size:20px}
  button.exp{background:#3498db;color:#fff}
  button.imp{background:#9b59b6;color:#fff}
  button.limpar{background:#c0392b;color:#fff;font-size:18px}
  #lista div{background:#1a1a5e;padding:16px;margin:10px 0;border-radius:12px;font-size:18px}
  h1{text-align:center;color:#ffd700;font-size:46px;margin:10px 0}
</style>
</head>

<body>
<div class="box">
  <h1>EXCLUSIVE PASS</h1>

  <button class="gerar" onclick="gerarIndividuais()">GERAR PNG INDIVIDUAIS</button>
  <button class="zip" onclick="gerarZip()">GERAR TODOS + ZIP (RECOMENDADO)</button>

  <button class="imp" onclick="document.getElementById('file').click()">IMPORTAR LISTA</button>
  <input type="file" id="file" style="display:none" accept=".json" onchange="importar(event)">

  <button class="limpar" onclick="limparTudo()">LIMPAR LISTA</button>

  <h2 style="color:#00d4aa;margin-top:30px">Convidados (<span id="total">0</span>)</h2>
  <div id="lista"></div>
</div>

<script src="https://cdn.jsdelivr.net/npm/davidshimjs-qrcodejs@0.0.2/qrcode.min.js"></script>
<script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.2.0/crypto-js.min.js"></script>

<script>
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('sw.js')
      .then(reg => console.log('SW registrado com sucesso'))
      .catch(err => console.log('SW falhou:', err));
  });
}
</script>

<script>
let lista = JSON.parse(localStorage.getItem("n")||"[]");
atualiza();

/* ------------------------- DOWNLOAD --------------------------*/
function download(blob, nome) {
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url; a.download = nome;
  document.body.appendChild(a);
  a.click();
  setTimeout(() => { URL.revokeObjectURL(url); document.body.removeChild(a); }, 100);
}

/* ------------------------- CRIA CONVITE --------------------------*/
async function criarConvite(p) {
  // 1) Constrói o SVG (como string)
  const svg = `
  <svg xmlns='http://www.w3.org/2000/svg' width='600' height='1066' viewBox='0 0 600 1066' preserveAspectRatio='none'>
    <g fill='none' stroke='#d4af37' stroke-linecap='round'>
      <line x1='-120' y1='100' x2='700' y2='-50' stroke-width='6' opacity='0.60' />
      <line x1='650' y1='400' x2='-100' y2='-50' stroke-width='5' opacity='0.50' />
      <line x1='-150' y1='800' x2='700' y2='250' stroke-width='5' opacity='0.55' />
      <line x1='0' y1='1100' x2='700' y2='450' stroke-width='6' opacity='0.65' />
      <!-- pequenos traços para dar variação -->
      <line x1='400' y1='20' x2='580' y2='120' stroke-width='2' opacity='0.35' />
      <line x1='20' y1='900' x2='260' y2='700' stroke-width='2.5' opacity='0.35' />
    </g>
  </svg>`.trim();

  // 2) codifica para base64 (seguro para data-url)
  const svgBase64 = 'data:image/svg+xml;base64,' + btoa(unescape(encodeURIComponent(svg)));

  // 3) cria o container do convite e aplica o background SVG como background-image
  const div = document.createElement("div");
  div.style.cssText = `
    width:600px;height:1066px;
    background:#212B37;
    background-image: url("${svgBase64}");
    background-size: cover;
    background-repeat: no-repeat;
    background-position: center;
    border-radius:50px;overflow:hidden;
    position:absolute;left:-9999px;top:0;
    display:flex;flex-direction:column;align-items:center;
    justify-content:flex-start;padding:80px 50px 60px;
    box-sizing:border-box;font-family:'Cinzel',serif;
    gap:40px;
  `;

  // primeiro nome
  const primeiroNome = (p.nome||'').trim().split(" ")[0].toUpperCase();

  // 4) conteúdo do convite (todo com z-index alto para ficar SOBRE o background)
  div.innerHTML = `
    <div style="z-index:2;background:#1a1a2e;color:#FFFFFF; font-size:34px;font-weight:bold; padding:22px 90px;border-radius:50px;">FESTA EXCLUSIVA</div>

    <p style="z-index:2;color:#a0e7ff;font-size:36px;margin:0;">Você está convidado(a)!</p>

    <h1 style="z-index:2;font-size:52px;font-weight:bold;color:#FFFFFF;text-shadow:0 8px 30px rgba(0,0,0,0.8);margin:0;">${primeiroNome}</h1>

    <div style="z-index:2;background:#1a1a2e;color:white;font-size:56px;font-weight:bold;padding:35px 140px;border-radius:70px;">${p.categoria}</div>

    <div id="qr-${p.id}" style="
      z-index:3;
      width:420px;height:420px;
      background:white;padding:30px;
      border-radius:45px;
      box-shadow:0 25px 60px rgba(0,0,0,0.8);
      display:flex;justify-content:center;align-items:center;
    "></div>

    <p style="z-index:2;color:#ccc;font-size:24px;margin:30px 0 0;line-height:1.4;text-align:center;">
      Código válido para entrada única<br>Validação 100% offline
    </p>
  `;

  // append temporário para renderização do QR
  document.body.appendChild(div);

  // 5) gerar QR code (vai dentro do #qr-...)
  new QRCode(div.querySelector(`#qr-${p.id}`), {
    text: p.id,
    width: 360,
    height: 360,
    colorDark: "#000000",
    colorLight: "#ffffff",
    correctLevel: QRCode.CorrectLevel.H
  });

  // 6) aguardar um pequeno tempo para garantir renderização do QR (pode ajustar)
  await new Promise(r => setTimeout(r, 1100));

  // 7) captura por html2canvas - background via data URL será renderizado SOB o conteúdo
  const canvas = await html2canvas(div, {
    scale: 3,
    backgroundColor: null,
    logging: false,
    allowTaint: true,
    useCORS: true
  });

  // limpa DOM e retorna canvas
  document.body.removeChild(div);
  return canvas;
}

  /* Ajuste de fonte automática (mantive caso queira usar) */
function ajustarFonte(elemento, tamanhoInicial, tamanhoMinimo) {
  let size = tamanhoInicial;
  while (
    elemento.scrollHeight > elemento.clientHeight + 10 ||
    elemento.scrollWidth > elemento.clientWidth
  ) {
    if (size <= tamanhoMinimo) break;
    size -= 4;
    elemento.style.fontSize = size + "px";
  }
}

/* ------------------------- GERAR PNG --------------------------*/
async function gerarIndividuais() {
  if (!lista.length) return alert("Lista vazia!");

  for (let p of lista) {
    const canvas = await criarConvite(p);
    const dataURL = canvas.toDataURL("image/png");
    window.open(dataURL, "_blank");
  }

  alert("PNG gerados!");
}

/* ------------------------- GERAR ZIP --------------------------*/
async function gerarZip() {
  if (!lista.length) return alert("Lista vazia!");

  const zip = new JSZip();
  const pasta = zip.folder("EXCLUSIVE_PASS");

  for (let p of lista) {
    const canvas = await criarConvite(p);
    const blob = await new Promise(res => canvas.toBlob(res));
    pasta.file(`${p.nome.split(" ")[0]}_${p.categoria}.png`, blob);
  }

  const zipBlob = await zip.generateAsync({type:"blob"});
  zip.generateAsync({ type: "base64" }).then(base64 => {
  const url = "data:application/zip;base64," + base64;
  window.open(url, "_blank");
});
}

/* ------------------------- IMPORTAR --------------------------*/
function importar(e){
  const file = e.target.files[0];
  if(!file) return;

  const reader = new FileReader();
  reader.onload = function(ev){
    const textoCripto = ev.target.result.trim();

    // FRASE SECRETA — TEM QUE SER A MESMA DO CONVERSOR
    const FRASE_SECRETA = "QSBmZXN0YSBkbyBDYWxpbCBkaWEgMTIvMTIgw6kgc8OzIHByYSBxdWVtIMOpIFZJUCBkZSB2ZXJkYWRlIDI1MTI";

    // Gera a chave e IV iguais aos do conversor
    const chave = CryptoJS.SHA256(FRASE_SECRETA + "ExclusivePass2025").toString();
    const iv = CryptoJS.SHA256("PASSEVIP" + FRASE_SECRETA).toString().substr(0,16);

    try{
      const bytes = CryptoJS.AES.decrypt(textoCripto, chave, {
        iv: CryptoJS.enc.Utf8.parse(iv),
        mode: CryptoJS.mode.CBC,
        padding: CryptoJS.pad.Pkcs7
      });

      const jsonPuro = bytes.toString(CryptoJS.enc.Utf8);
      if(!jsonPuro || !jsonPuro.startsWith('[')) throw "inválido";

      lista = JSON.parse(jsonPuro);
      salvar();
      atualiza();

      alert("Lista importada com sucesso!");

    }catch(err){
      console.error("Erro ao decodificar lista:", err);
      alert("Arquivo inválido! Use apenas arquivos gerados pelo conversor.");
    }
  };

  reader.readAsText(file);
}


/* ------------------------- OUTROS --------------------------*/
function salvar(){ localStorage.setItem("n", JSON.stringify(lista)); }

function atualiza(){
  const l = document.getElementById("lista");
  l.innerHTML = lista.map(p=>`<div><b>${p.nome}</b> — ${p.categoria}</div>`).join("");
  document.getElementById("total").textContent = lista.length;
}

function limparTudo(){
  if(confirm("APAGAR TUDO?")){
    lista=[]; salvar(); atualiza();
  }
}
</script>
</body>
</html>
