<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>EXCLUSIVE PASS - Sistema Completo</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.2.0/crypto-js.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
<style>
  body{font-family:'Segoe UI',sans-serif;background:#0f0c29;color:#eee;margin:0;padding:20px}
  .box{max-width:900px;margin:auto;background:#16213e;padding:30px;border-radius:20px;box-shadow:0 0 30px #000}
  input,select,button{padding:16px;margin:10px 0;width:100%;border-radius:15px;border:none;font-size:18px;box-sizing:border-box}
  button{background:#00d4aa;color:#000;font-weight:bold;cursor:pointer}
  button:hover{background:#00ffc4}
  button.gerar{background:#ffd700;color:#000;font-size:20px}
  button.zip{background:#e67e22;color:#fff;font-size:20px}
  button.excluir{background:#e74c3c;color:#fff;padding:8px 16px;margin-left:10px;font-size:14px}
  button.exp{background:#e67e22}
  button.imp{background:#9b59b6}
  button.limpar{background:#c0392b;color:#fff;font-weight:bold;font-size:18px}
  button.limpar:hover{background:#e74c3c}
  #lista div{background:#1a1a5e;padding:16px;margin:10px 0;border-radius:12px;display:flex;justify-content:space-between;align-items:center;font-size:18px}
  h1{text-align:center;color:#ffffff;font-size:46px;margin:10px 0}
</style>
</head>
<body>
<div class="box">
  <h1>EXCLUSIVE PASS</h1>
  
  <input type="text" id="nome" placeholder="Nome completo">
  <input type="text" id="acomp" placeholder="Acompanhantes (opcional)">
  <select id="cat">
    <option>VIP</option><option>PISTA</option><option>CAMAROTE</option><option>MESA</option><option>OPEN BAR</option>
  </select>
  
  <button onclick="add()">Adicionar à lista</button>
  <button class="gerar" onclick="todos()">GERAR TODOS OS PDF (individual)</button>
  <button class="zip" onclick="gerarZip()">GERAR TODOS + ZIP (recomendado)</button>
  <button class="exp" onclick="exportar()">EXPORTAR LISTA (JSON)</button>
  <button class="imp" onclick="document.getElementById('file').click()">IMPORTAR LISTA CRIPTOGRAFADA</button>
  <input type="file" id="file" style="display:none" accept=".json" onchange="importar(event)">
  
  <button class="limpar" onclick="limparTudo()">LIMPAR TODA A LISTA</button>

  <h2 style="color:#00d4aa">Convidados (<span id="total">0</span>)</h2>
  <div id="lista"></div>
</div>

<script src="qrcode.min.js"></script>
<script src="jspdf.umd.min.js"></script>
<script src="html2canvas.min.js"></script>

<script>
let lista = JSON.parse(localStorage.getItem("n")||"[]");
atualiza();

// === FUNÇÃO NOVA: GERAR ZIP COM TODOS OS PDF ===
async function gerarZip(){
  if(!lista.length) return alert("Lista vazia!");
  
  const zip = new JSZip();
  const pasta = zip.folder("Convites_EXCLUSIVE_PASS");

  alert("Gerando ZIP com todos os convites... Aguarde!");

  for(let i = 0; i < lista.length; i++){
    const p = lista[i];
    const pdfBlob = await geraPDFcomoBlob(p);
    const nomeArquivo = `${p.nome.split(" ")[0]}_${p.categoria}.pdf`;
    pasta.file(nomeArquivo, pdfBlob);
  }

  const zipBlob = await zip.generateAsync({type:"blob"});
  saveAs(zipBlob, `EXCLUSIVE_PASS_TODOS_CONVITES_${lista.length}p.zip`);
  alert(`PRONTO! ZIP baixado com ${lista.length} convites!`);
}

// Gera PDF como Blob (pra colocar no ZIP)
async function geraPDFcomoBlob(p){
  const convite = document.createElement("div");
  convite.style.cssText = "width:560px;height:1000px;background:linear-gradient(135deg,#667eea,#764ba2);border-radius:45px;overflow:hidden;display:flex;align-items:center;justify-content:center;box-shadow:0 30px 80px rgba(0,0,0,0.9);position:absolute;left:-9999px;";

  const inner = document.createElement("div");
  inner.style.cssText = "width:100%;padding:80px 45px 120px;text-align:center;color:white;box-sizing:border-box;";
  inner.innerHTML = `
    <div style="background:rgba(0,0,0,0.5);color:#ffff00;font-size:46px;font-weight:bold;padding:20px 80px;border-radius:50px;display:inline-block;">
      FESTA EXCLUSIVA
    </div>
    <p style="color:#000000;font-size:34px;margin:50px 0 25px;">Você está convidado(a)!</p>
    <h1 style="font-size:66px;margin:20px 0 45px;color:#FFFFFF;text-shadow:0 5px 15px rgba(0,0,0,0.7);">
      ${p.nome.toUpperCase()}
    </h1>
    <p style="font-size:32px;color:#ddd;margin:25px 0 60px;">${p.acomp ? "+ "+p.acomp : ""}</p>
    <div style="background:#1a1a2e;color:white;font-size:42px;font-weight:bold;padding:25px 110px;border-radius:60px;display:inline-block;margin-bottom:80px;">
      ${p.categoria}
    </div>
    <div id="qr_${p.id}" style="width:360px;height:360px;margin:0 auto 80px;background:white;padding:60px;border-radius:40px;box-shadow:0 10px 30px rgba(0,0,0,0.3);"></div>
    <p style="color:#ccc;font-size:21px;line-height:1.6;">
      Código válido para entrada única<br>Validação 100% offline
    </p>
  `;
  convite.appendChild(inner);
  document.body.appendChild(convite);

  new QRCode(document.getElementById(`qr_${p.id}`), {
    text: p.id, width: 360, height: 360,
    colorDark: "#000000", colorLight: "#ffffff",
    correctLevel: QRCode.CorrectLevel.H
  });

  await new Promise(r => setTimeout(r, 1800));

  const canvas = await html2canvas(convite, {scale:3, backgroundColor:null});
  const img = canvas.toDataURL("image/png");
  const {jsPDF} = window.jspdf;
  const pdf = new jsPDF("p","mm","a4");
  const w = 180;
  const h = (canvas.height * w) / canvas.width;
  pdf.addImage(img,"PNG",15,(297-h)/2,w,h);

  document.body.removeChild(convite);
  return pdf.output("blob");
}

// === RESTANTE DO CÓDIGO (add, importar, etc) ===
function add(){
  let n=document.getElementById("nome").value.trim();
  let a=document.getElementById("acomp").value.trim();
  let c=document.getElementById("cat").value;
  if(!n) return alert("Nome obrigatório!");
  let id = Date.now().toString(36)+Math.random().toString(36).substr(2);
  lista.push({id,nome:n,acomp:a,categoria:c,usado:false});
  salvar(); document.getElementById("nome").value=""; document.getElementById("acomp").value="";
  atualiza();
}

function salvar(){ localStorage.setItem("n",JSON.stringify(lista)); }
function atualiza(){
  let l=document.getElementById("lista"); l.innerHTML="";
  lista.forEach((x,i)=>{
    l.innerHTML += `<div><span><b>${x.nome}</b> — ${x.categoria} ${x.acomp? "(+"+x.acomp+")":""}</span>
                    <button class="excluir" onclick="excluir(${i})">Excluir</button></div>`;
  });
  document.getElementById("total").textContent = lista.length;
}

function excluir(i){ if(confirm(`Excluir ${lista[i].nome}?`)){ lista.splice(i,1); salvar(); atualiza(); } }
function limparTudo(){ if(lista.length && confirm("APAGAR TUDO?") && confirm("Sério?")){ lista=[]; salvar(); atualiza(); } }
function exportar(){ const a=document.createElement("a"); a.href="data:text/json;charset=utf-8,"+encodeURIComponent(JSON.stringify(lista)); a.download="lista_convidados.json"; a.click(); }

async function todos(){
  if(!lista.length) return alert("Lista vazia!");
  for(let p of lista){ await geraPDFcomoBlob(p).then(blob => { const url = URL.createObjectURL(blob); const a = document.createElement("a"); a.href=url; a.download=`${p.nome.split(" ")[0]}_${p.categoria}.pdf`; a.click(); URL.revokeObjectURL(url); }); await new Promise(r=>setTimeout(r,1200)); }
  alert("Todos os PDFs gerados individualmente!");
}

function importar(e){
  const file = e.target.files[0];
  if(!file) return;
  
  const reader = new FileReader();
  reader.onload = function(ev){
    const textoCripto = ev.target.result.trim();
    
    // FRASE SECRETA QUE SÓ VOCÊ SABE (mude pra sua frase real)
    const FRASE_SECRETA = "QSBmZXN0YSBkbyBDYWxpbCBkaWEgMTIvMTIgw6kgc8OzIHByYSBxdWVtIMOpIFZJUCBkZSB2ZXJkYWRlIDI1MTI";
    
    // Gera uma chave forte a partir da frase (impossível de reverter)
    const chave = CryptoJS.SHA256(FRASE_SECRETA + "ExclusivePass2025").toString();
    const salt = CryptoJS.SHA256("CalilVIP" + FRASE_SECRETA).toString().substr(0,16);

    try{
      const bytes = CryptoJS.AES.decrypt(textoCripto, chave, {
        iv: CryptoJS.enc.Utf8.parse(salt),
        mode: CryptoJS.mode.CBC,
        padding: CryptoJS.pad.Pkcs7
      });

      const jsonPuro = bytes.toString(CryptoJS.enc.Utf8);
      if(!jsonPuro || !jsonPuro.startsWith('[')) throw "inválido";

      lista = JSON.parse(jsonPuro);
      salvar();
      atualiza();
      if(document.getElementById("total")) document.getElementById("total").textContent = lista.length;
      if(document.getElementById("contador")) document.getElementById("contador").textContent = lista.filter(p=>p.usado).length;
      if(typeof atualizarLista === "function") atualizarLista();

    }catch(err){
      alert("Lista inválida ou corrompida!\nUse apenas arquivos gerados pelo sistema oficial.");
    }
  };
  reader.readAsText(file);
}
</script>
</body>
</html>
