<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <link rel="manifest" href="manifest.json">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="apple-mobile-web-app-title" content="EXCLUSIVE PASS">
  <link rel="apple-touch-icon" href="/icons/icon-180.png">

  <meta charset="UTF-8">
  <title>EXCLUSIVE PASS - DESIGN FINAL</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&display=swap" rel="stylesheet">

<style>
  body{font-family:'Segoe UI',sans-serif;background:#0f0c29;color:#eee;margin:0;padding:20px}
  .box{max-width:900px;margin:auto;background:#16213e;padding:30px;border-radius:20px;box-shadow:0 0 40px #000}
  button{padding:16px;margin:10px 0;width:100%;border-radius:15px;border:none;font-size:18px;cursor:pointer;font-weight:bold}
  button.gerar{background:#ffd700;color:#000;font-size:20px}
  button.zip{background:#e67e22;color:#fff;font-size:20px}
  button.exp{background:#3498db;color:#fff}
  button.imp{background:#9b59b6;color:#fff}
  button.limpar{background:#c0392b;color:#fff;font-size:18px}
  #lista div{background:#1a1a5e;padding:16px;margin:10px 0;border-radius:12px;font-size:18px}
  h1{text-align:center;color:#ffd700;font-size:46px;margin:10px 0}
</style>
</head>

<body>
<div class="box">
  <h1>EXCLUSIVE PASS</h1>

  <button class="gerar" onclick="gerarEPublicarConvites()">
  GERAR + PUBLICAR CONVITES ONLINE (RECOMENDADO 2025)
    </button>
  <button class="zip" onclick="gerarZip()">GERAR TODOS + ZIP (RECOMENDADO)</button>
  <button class="zip" onclick="enviarTodosWhatsApp()" style="background:#25d366;color:#fff;font-size:20px;margin-top:15px;">
  ENVIAR TODOS POR WHATSAPP (com convite)
  </button>

  <button class="imp" onclick="document.getElementById('file').click()">IMPORTAR LISTA</button>
  <input type="file" id="file" style="display:none" accept=".json" onchange="importar(event)">

  <button class="limpar" onclick="limparTudo()">LIMPAR LISTA</button>

  <h2 style="color:#00d4aa;margin-top:30px">Convidados (<span id="total">0</span>)</h2>
  <div id="lista"></div>
</div>

<script src="https://cdn.jsdelivr.net/npm/davidshimjs-qrcodejs@0.0.2/qrcode.min.js"></script>
<script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.2.0/crypto-js.min.js"></script>

<script>
let lista = JSON.parse(localStorage.getItem("n")||"[]");
atualiza();

/* ------------------------- DOWNLOAD --------------------------*/
function download(blob, nome) {
  const url = URL.createObjectURL(blob);

  // For√ßa download sem criar aba nova
  const a = document.createElement("a");
  a.style.display = "none";
  a.href = url;
  a.download = nome;

  document.body.appendChild(a);
  a.click();

  setTimeout(() => {
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  }, 300);
}
/*------------------------- ENVIAR TODOS ZAP -------------------------------*/
async function enviarTodosWhatsApp() {
  const comTelefone = lista.filter(p => p.telefone && p.telefone.replace(/\D/g, '').length >= 10);
  if (comTelefone.length === 0) return alert("Nenhum convidado com telefone v√°lido!");

  if (!confirm(`Enviar para ${comTelefone.length} pessoas?\n\nSer√° gerado um convite para cada um.\nVoc√™ controlar√° o envio manualmente (pr√≥ximo ‚Üí cola ‚Üí envia).\n\nContinuar?`)) return;

  const botao = event.target;
  const textoOriginal = botao.textContent;
  botao.disabled = true;

  const convites = [];

  try {
    // === ETAPA 1: GERA TODOS OS CONVITES COM PROGRESSO ===
    for (let i = 0; i < comTelefone.length; i++) {
      botao.textContent = `Gerando convite ${i + 1} de ${comTelefone.length}...`;
      
      const canvas = await criarConvite(comTelefone[i]);
      const blob = await new Promise(res => canvas.toBlob(res, 'image/png', 0.95));
      
      convites.push({
        pessoa: comTelefone[i],
        blob
      });

      // Atualiza a cada 3 convites (evita travar o bot√£o)
      if (i % 3 === 2 || i === comTelefone.length - 1) {
        await new Promise(r => setTimeout(r, 1)); // deixa o navegador respirar
      }
    }

    botao.textContent = "Convites prontos! Abrindo janela...";

    // === ETAPA 2: ABRE JANELA DE ENVIO ===
    const win = window.open('', '_blank', 'width=560,height=780,scrollbars=yes');
    
    win.convitesDados = convites.map(c => ({
      nome: c.pessoa.nome,
      telefone: c.pessoa.telefone.replace(/\D/g, ''),
      categoria: c.pessoa.categoria,
      acomp: c.pessoa.acomp || ""
    }));
    win.convitesBlobs = convites.map(c => c.blob);

    win.document.write(`
      <!DOCTYPE html>
      <html><head><meta charset="utf-8"><title>Envio em Massa</title>
      <style>
        body{font-family:Segoe UI,Arial;background:#0f0c29;color:#eee;margin:0;padding:20px;text-align:center}
        h2{color:#25d366;font-size:30px;margin:15px}
        .box{background:#16213e;padding:30px;border-radius:20px;max-width:500px;margin:20px auto;box-shadow:0 0 40px #000}
        button{padding:18px 40px;font-size:22px;background:#25d366;color:#000;border:none;border-radius:15px;margin:20px;cursor:pointer;font-weight:bold}
        #nome{font-size:32px;color:#ffd700;margin:30px 0}
        .info{color:#00d4aa;font-size:18px}
      </style></head>
      <body>
        <div class="box">
          <h2>EXCLUSIVE PASS</h2>
          <div class="info"><strong>${convites.length}</strong> convites carregados!</div>
          <button id="btn">PR√ìXIMO CONVIDADO</button>
          <div id="nome">Clique para come√ßar</div>
        </div>
        <script>
          let i = 0;
          const d = window.convitesDados || [];
          const b = window.convitesBlobs || [];
          document.getElementById("btn").onclick = async () => {
            if (i >= d.length) {
              document.body.innerHTML = "<h2 style='color:#25d366'>TODOS ENVIADOS!</h2><p>Miss√£o cumprida!</p>";
              return;
            }
            const p = d[i];
            document.getElementById("nome").innerHTML = p.nome.split(" ")[0] + "<br><small>" + p.categoria + (p.acomp?" + "+p.acomp:"") + "</small>";
            if (b[i] && navigator.clipboard?.write) await navigator.clipboard.write([new ClipboardItem({"image/png": b[i]})]);
            const msg = encodeURIComponent("Ol√° *"+p.nome.split(" ")[0]+"*! \\n\\nFESTA EXCLUSIVA!\\nCategoria: *"+p.categoria+"*"+(p.acomp?"\\nAcompanhantes: +"+p.acomp:"")+"\\n\\nSeu convite com QR Code est√° anexado abaixo!\\n\\nTe vejo l√°!");
            window.open("https://wa.me/55"+p.telefone+"?text="+msg, "_blank");
            i++;
            document.getElementById("btn").textContent = "PR√ìXIMO (" + i + "/" + d.length + ")";
          };
        <\/script>
      </body></html>
    `);
    win.document.close();

    // === FINALIZA O BOT√ÉO ===
    botao.textContent = `PRONTO! ${convites.length} convites gerados`;
    setTimeout(() => {
      botao.textContent = textoOriginal;
      botao.disabled = false;
    }, 4000);

    alert(`SUCESSO!\n\n${convites.length} convites gerados e janela aberta.\n\nAgora √© s√≥ clicar em PR√ìXIMO ‚Üí Ctrl+V ‚Üí Enviar ‚Üí repetir`);

  } catch (err) {
    console.error(err);
    botao.textContent = "ERRO - Tente novamente";
    botao.disabled = false;
    alert("Erro ao gerar convites. Tente novamente.");
  }
}
/* ------------------------- CRIA CONVITE --------------------------*/
async function criarConvite(p) {
  // 1) Constr√≥i o SVG (como string)
  const svg = `
  <svg xmlns='http://www.w3.org/2000/svg' width='600' height='1066' viewBox='0 0 600 1066' preserveAspectRatio='none'>
    <g fill='none' stroke='#d4af37' stroke-linecap='round'>
      <line x1='-120' y1='100' x2='700' y2='-50' stroke-width='6' opacity='0.60' />
      <line x1='650' y1='400' x2='-100' y2='-50' stroke-width='5' opacity='0.50' />
      <line x1='-150' y1='800' x2='700' y2='250' stroke-width='5' opacity='0.55' />
      <line x1='0' y1='1100' x2='700' y2='450' stroke-width='6' opacity='0.65' />
      <!-- pequenos tra√ßos para dar varia√ß√£o -->
      <line x1='400' y1='20' x2='580' y2='120' stroke-width='2' opacity='0.35' />
      <line x1='20' y1='900' x2='260' y2='700' stroke-width='2.5' opacity='0.35' />
    </g>
  </svg>`.trim();

  // 2) codifica para base64 (seguro para data-url)
  const svgBase64 = 'data:image/svg+xml;base64,' + btoa(unescape(encodeURIComponent(svg)));

  // 3) cria o container do convite e aplica o background SVG como background-image
  const div = document.createElement("div");
  div.style.cssText = `
    width:600px;height:1066px;
    background:#212B37;
    background-image: url("${svgBase64}");
    background-size: cover;
    background-repeat: no-repeat;
    background-position: center;
    border-radius:50px;overflow:hidden;
    position:absolute;left:-9999px;top:0;
    display:flex;flex-direction:column;align-items:center;
    justify-content:flex-start;padding:80px 50px 60px;
    box-sizing:border-box;font-family:'Cinzel',serif;
    gap:40px;
  `;

  // primeiro nome
  const primeiroNome = (p.nome||'').trim().split(" ")[0].toUpperCase();

  // 4) conte√∫do do convite (todo com z-index alto para ficar SOBRE o background)
  div.innerHTML = `
    <div style="z-index:2;background:#1a1a2e;color:#FFFFFF; font-size:34px;font-weight:bold; padding:22px 90px;border-radius:50px;">FESTA EXCLUSIVA</div>

    <p style="z-index:2;color:#a0e7ff;font-size:36px;margin:0;">Voc√™ est√° convidado(a)!</p>

    <h1 style="z-index:2;font-size:52px;font-weight:bold;color:#FFFFFF;text-shadow:0 8px 30px rgba(0,0,0,0.8);margin:0;">${primeiroNome}</h1>

    <div style="z-index:2;background:#1a1a2e;color:white;font-size:56px;font-weight:bold;padding:35px 140px;border-radius:70px;">${p.categoria}</div>

    <div id="qr-${p.id}" style="
      z-index:3;
      width:420px;height:420px;
      background:white;padding:30px;
      border-radius:45px;
      box-shadow:0 25px 60px rgba(0,0,0,0.8);
      display:flex;justify-content:center;align-items:center;
    "></div>

    <p style="z-index:2;color:#ccc;font-size:24px;margin:30px 0 0;line-height:1.4;text-align:center;">
      C√≥digo v√°lido para entrada √∫nica<br>Valida√ß√£o 100% offline
    </p>
  `;

  // append tempor√°rio para renderiza√ß√£o do QR
  document.body.appendChild(div);

  // 5) gerar QR code (vai dentro do #qr-...)
  new QRCode(div.querySelector(`#qr-${p.id}`), {
    text: p.id,
    width: 360,
    height: 360,
    colorDark: "#000000",
    colorLight: "#ffffff",
    correctLevel: QRCode.CorrectLevel.H
  });

  // 6) aguardar um pequeno tempo para garantir renderiza√ß√£o do QR (pode ajustar)
  await new Promise(r => setTimeout(r, 1100));

  // 7) captura por html2canvas - background via data URL ser√° renderizado SOB o conte√∫do
  const canvas = await html2canvas(div, {
    scale: 3,
    backgroundColor: null,
    logging: false,
    allowTaint: true,
    useCORS: true
  });

  // limpa DOM e retorna canvas
  document.body.removeChild(div);
  return canvas;
}

  /* Ajuste de fonte autom√°tica (mantive caso queira usar) */
function ajustarFonte(elemento, tamanhoInicial, tamanhoMinimo) {
  let size = tamanhoInicial;
  while (
    elemento.scrollHeight > elemento.clientHeight + 10 ||
    elemento.scrollWidth > elemento.clientWidth
  ) {
    if (size <= tamanhoMinimo) break;
    size -= 4;
    elemento.style.fontSize = size + "px";
  }
}

function enviarTodosWhats(){
  if(!lista.length) return alert("Lista vazia!");

  if(!confirm(`Isso vai abrir ${lista.length} abas do WhatsApp (uma para cada pessoa com telefone).\n\nContinuar?`)) return;

  lista.forEach((p, i) => {
    const tel = (p.telefone||"").replace(/\D/g,"");
    if(!tel) return;

    const texto = encodeURIComponent(
      `Ol√° *${p.nome.split(" ")[0]}*! üéâ\n\nVoc√™ est√° convidado(a) para a *FESTA EXCLUSIVA*!\nCategoria: *${p.categoria}*\n\nEm breve envio seu convite com QR Code.\nTe vejo l√°! üî•`
    );

    setTimeout(() => {
      window.open(`https://wa.me/55${tel}?text=${texto}`, "_blank");
    }, i * 1200); // abre uma a cada 1,2 segundos (evita bloqueio)
  });

  alert("Abas do WhatsApp sendo abertas‚Ä¶ envie os convites quando quiser!");
}

/* ------------------------- GERAR PNG --------------------------*/
async function gerarEPublicarConvites() {
  if (!lista.length) return alert("Lista vazia!");

  const botao = event.target;
  const textoOriginal = botao.textContent;
  botao.disabled = true;
  botao.textContent = "Gerando e publicando...";

  const convitesPublicados = [];

  try {
    for (let i = 0; i < lista.length; i++) {
      const p = lista[i];
      botao.textContent = `Publicando ${i + 1}/${lista.length}: ${p.nome.split(" ")[0]}...`;

      // Gera o convite
      const canvas = await criarConvite(p);
      const blob = await new Promise(r => canvas.toBlob(r, 'image/png', 0.95));

      // Gera senha curta e √∫nica (4 letras/n√∫meros)
      const senha = Math.random().toString(36).substring(2, 6).toUpperCase();

      // Converte para base64 para enviar
      const base64 = await new Promise(resolve => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result.split(',')[1]);
        reader.readAsDataURL(blob);
      });

      // Envia para o servidor (usando GitHub + Firebase gr√°tis)
      const response = await fetch('https://nalista-c58f2-default-rtdb.firebaseio.com/', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          nome: p.nome,
          categoria: p.categoria,
          senha: senha,
          imagem: base64,
          data: new Date().toISOString().split('T')[0],
          usado: false
        })
      });

      if (response.ok) {
        const id = (await response.json()).name;
        const link = `https://calvinfmei-prog.github.io/convite/?id=${id}&s=${senha}`;
        convitesPublicados.push({ pessoa: p, link, senha });
      }
    }

    // Copia todos os links com senha para √°rea de transfer√™ncia
    const textoParaEnviar = convitesPublicados
      .map(c => `${c.pessoa.nome.split(" ")[0]} ‚Üí ${c.link} (senha: ${c.senha})`)
      .join("\n");

    await navigator.clipboard.writeText(textoParaEnviar);

    botao.textContent = `PRONTO! ${convitesPublicados.length} convites publicados`;
    alert(`SUCESSO TOTAL!\n\n${convitesPublicados.length} convites publicados online.\n\nTodos os links + senhas foram copiados!\n\nAgora √© s√≥ colar no WhatsApp e enviar em massa.`);

    setTimeout(() => {
      botao.textContent = textoOriginal;
      botao.disabled = false;
    }, 5000);

  } catch (err) {
    console.error(err);
    alert("Erro ao publicar. Verifique sua conex√£o.");
    botao.disabled = false;
    botao.textContent = textoOriginal;
  }
}
/*-------------------------- ENVIAR CONVITE PELO ZAP COM IMAGEM ------------------*/
async function enviarConviteWhats(index) {
  const p = lista[index];
  const botao = event.target;
  botao.disabled = true;
  botao.textContent = "Gerando convite...";

  try {
    // 1. Gera o convite (canvas)
    const canvas = await criarConvite(p);

    // 2. Converte para Blob (necess√°rio pro clipboard)
    const blob = await new Promise(resolve => canvas.toBlob(resolve, 'image/png', 0.95));

    // 3. Copia a imagem para a √°rea de transfer√™ncia
    if (navigator.clipboard && navigator.clipboard.write) {
      await navigator.clipboard.write([
        new ClipboardItem({ 'image/png': blob })
      ]);
    }

    // 4. Mensagem personalizada
    const mensagem = encodeURIComponent(
      `Ol√° *${p.nome.split(" ")[0]}*! üéâ\n\nVoc√™ est√° convidado(a) para a *FESTA EXCLUSIVA*!\n\nCategoria: *${p.categoria}*${p.acomp ? `\nAcompanhantes: +${p.acomp}` : ""}\n\nSeu convite individual com QR Code est√° anexado abaixo.\n\nTe vejo l√°! üî•`
    );

    // 5. Abre o WhatsApp
    const url = `https://wa.me/55${p.telefone.replace(/\D/g, '')}?text=${mensagem}`;
    window.open(url, '_blank');

    // 6. Feedback perfeito pro usu√°rio
    setTimeout(() => {
      botao.disabled = false;
      botao.textContent = "WhatsApp + Convite";

      if (/Android|iPhone|iPad|Mobi/.test(navigator.userAgent)) {
        alert(`Imagem copiada!\n\nNo WhatsApp que acabou de abrir:\nToque no campo de mensagem ‚Üí Cole (ou toque no + ‚Üí Galeria)\n\nConvite j√° est√° na sua √°rea de transfer√™ncia!`);
      } else {
        alert(`WhatsApp Web aberto!\n\nAgora √© s√≥ dar CTRL + V (ou clique com bot√£o direito ‚Üí Colar)\n\nA imagem do convite j√° est√° copiada!`);
      }
    }, 1500);

  } catch (err) {
    console.error(err);
    alert("Erro ao gerar o convite. Tente novamente.");
    botao.disabled = false;
    botao.textContent = "WhatsApp + Convite";
  }
}
/* ------------------------- GERAR ZIP --------------------------*/
async function gerarZip() {
  if (!lista.length) return alert("Lista vazia!");

  const botao = event.target;
  botao.disabled = true;
  botao.textContent = "GERANDO... (pode demorar)";

  try {
    const zip = new JSZip();
    const pasta = zip.folder("EXCLUSIVE_PASS");

    let contador = 0;
    const total = lista.length;

    for (let p of lista) {
      contador++;
      botao.textContent = `GERANDO... ${contador}/${total}`;

      const canvas = await criarConvite(p);
      const blob = await new Promise(res => canvas.toBlob(res, 'image/png', 0.95));
      
      const nomeArquivo = `${p.nome.trim().split(" ")[0]}_${p.categoria.replace(/[^a-zA-Z0-9]/g, "_")}.png`;
      pasta.file(nomeArquivo, blob);
    }

    botao.textContent = "FINALIZANDO ZIP...";

    const zipBlob = await zip.generateAsync({type: "blob"}, metadata => {
      // progresso opcional do ZIP
    });

    download(zipBlob, `EXCLUSIVE_PASS_${lista.length}_convites_${new Date().toLocaleDateString('pt-BR')}.zip`);
    
    alert(`SUCESSO! ${lista.length} convites gerados e baixados como ZIP.`);
  } catch (err) {
    console.error(err);
    alert("Erro ao gerar os convites. Tente novamente.");
  } finally {
    botao.disabled = false;
    botao.textContent = "GERAR TODOS + ZIP (RECOMENDADO)";
  }
}

/* ------------------------- IMPORTAR --------------------------*/
function importar(e){
  const file = e.target.files[0];
  if(!file) return;

  const reader = new FileReader();
  reader.onload = function(ev){
    const textoCripto = ev.target.result.trim();

    // FRASE SECRETA ‚Äî TEM QUE SER A MESMA DO CONVERSOR
    const FRASE_SECRETA = "QSBmZXN0YSBkbyBDYWxpbCBkaWEgMTIvMTIgw6kgc8OzIHByYSBxdWVtIMOpIFZJUCBkZSB2ZXJkYWRlIDI1MTI";

    // Gera a chave e IV iguais aos do conversor
    const chave = CryptoJS.SHA256(FRASE_SECRETA + "ExclusivePass2025").toString();
    const iv = CryptoJS.SHA256("PASSEVIP" + FRASE_SECRETA).toString().substr(0,16);

    try{
      const bytes = CryptoJS.AES.decrypt(textoCripto, chave, {
        iv: CryptoJS.enc.Utf8.parse(iv),
        mode: CryptoJS.mode.CBC,
        padding: CryptoJS.pad.Pkcs7
      });

      const jsonPuro = bytes.toString(CryptoJS.enc.Utf8);
      if(!jsonPuro || !jsonPuro.startsWith('[')) throw "inv√°lido";

      lista = JSON.parse(jsonPuro);
      salvar();
      atualiza();

      alert("Lista importada com sucesso!");

    }catch(err){
      console.error("Erro ao decodificar lista:", err);
      alert("Arquivo inv√°lido! Use apenas arquivos gerados pelo conversor.");
    }
  };

  reader.readAsText(file);
}


/* ------------------------- OUTROS --------------------------*/
function salvar(){ localStorage.setItem("n", JSON.stringify(lista)); }

function excluirConvidado(index){
  if(confirm(`Excluir "${lista[index].nome}" da lista?`)){
    lista.splice(index, 1);
    salvar();
    atualiza();
  }
}

function atualiza(){
  const l = document.getElementById("lista");
  l.innerHTML = lista.map((p, index) => {
    const telefone = (p.telefone || "").replace(/\D/g, "");
    const temWhats = telefone.length >= 10;

    return `
      <div style="display:flex; flex-wrap:wrap; gap:10px; justify-content:space-between; align-items:center; background:#1a1a5e; padding:16px; margin:10px 0; border-radius:12px; font-size:18px;">
        <div>
          <b>${p.nome}</b> ‚Äî ${p.categoria}
          ${temWhats ? `<small style="color:#25d366">(${telefone.replace(/(\d{2})(\d{5})(\d{4})/, "($1) $2-$3")})</small>` : ""}
        </div>
        <div style="display:flex; gap:8px;">
          ${temWhats ? `<button onclick="enviarConviteWhats(${index})" style="background:#25d366; color:white; border:none; padding:8px 14px; border-radius:8px; cursor:pointer; font-size:14px;">
            WhatsApp + Convite
          </button>` : ""}
          <button onclick="excluirConvidado(${index})" style="background:#e74c3c; color:white; border:none; padding:8px 14px; border-radius:8px; cursor:pointer; font-size:14px;">
            Excluir
          </button>
        </div>
      </div>
    `;
  }).join("");

  document.getElementById("total").textContent = lista.length;
}

function limparTudo(){
  if(confirm("APAGAR TUDO?")){
    lista=[]; salvar(); atualiza();
  }
}
</script>
</body>
</html>
